#include <stdint.h>

struct sym8b10b {
        uint8_t result;
        uint8_t next_rd;
};

static struct sym8b10b tab3b4b[][9] = {
        {
                { 0b1011, 1 },
                { 0b1001, 0 },
                { 0b0101, 0 },
                { 0b1100, 1 },
                { 0b1101, 1 },
                { 0b1010, 0 },
                { 0b0110, 0 },
                { 0b1110, 1 },
                { 0b0111, 1 }
        },
        {
                { 0b0100, 0 },
                { 0b1001, 1 },
                { 0b0101, 1 },
                { 0b0011, 0 },
                { 0b0010, 0 },
                { 0b1010, 1 },
                { 0b0110, 1 },
                { 0b0001, 0 },
                { 0b1000, 0 }
        }
};

static struct sym8b10b tab5b6b[][32] = {
        {
                { 0b100111, 1 },
                { 0b011101, 1 },
                { 0b101101, 1 },
                { 0b110001, 0 },
                { 0b110101, 1 },
                { 0b101001, 0 },
                { 0b011001, 0 },
                { 0b111000, 1 },
                { 0b111001, 1 },
                { 0b100101, 0 },
                { 0b010101, 0 },
                { 0b110100, 0 },
                { 0b001101, 0 },
                { 0b101100, 0 },
                { 0b011100, 0 },
                { 0b010111, 1 },
                { 0b011011, 1 },
                { 0b100011, 0 },
                { 0b010011, 0 },
                { 0b110010, 0 },
                { 0b001011, 0 },
                { 0b101010, 0 },
                { 0b011010, 0 },
                { 0b111010, 1 },
                { 0b110011, 1 },
                { 0b100110, 0 },
                { 0b010110, 0 },
                { 0b110110, 1 },
                { 0b001110, 0 },
                { 0b101110, 1 },
                { 0b011110, 1 },
                { 0b101011, 1 }
        },
        {
                { 0b011000, 0 },
                { 0b100010, 0 },
                { 0b010010, 0 },
                { 0b110001, 1 },
                { 0b001010, 0 },
                { 0b101001, 1 },
                { 0b011001, 1 },
                { 0b000111, 0 },
                { 0b000110, 0 },
                { 0b100101, 1 },
                { 0b010101, 1 },
                { 0b110100, 1 },
                { 0b001101, 1 },
                { 0b101100, 1 },
                { 0b011100, 1 },
                { 0b101000, 0 },
                { 0b100100, 0 },
                { 0b100011, 1 },
                { 0b010011, 1 },
                { 0b110010, 1 },
                { 0b001011, 1 },
                { 0b101010, 1 },
                { 0b011010, 1 },
                { 0b000101, 0 },
                { 0b001100, 0 },
                { 0b100110, 1 },
                { 0b010110, 1 },
                { 0b001001, 0 },
                { 0b001110, 1 },
                { 0b010001, 0 },
                { 0b100001, 0 },
                { 0b010100, 0 }
        }
};

uint16_t
encode_8b10b(uint8_t p8b, uint8_t *rd)
{
        uint8_t p3b, p5b, p4b, p6b;
        struct sym8b10b p4br, p6br;
        p5b = p8b & 0b00011111;
        p3b = (p8b & 0b11100000) >> 5;


        p6br = tab5b6b[*rd][p5b];
        *rd = p6br.next_rd;
        p6b = p6br.result;
        
        if ((*rd && !(p6b & 0b11) || !*rd && (p6b & 0b11 == 0b11))
                        && p3b == 0b111)
                p3b++;

        p4br = tab3b4b[*rd][p3b];
        *rd = p4br.next_rd;
        p4b = p4br.result;

        return ((uint16_t)p6b << 4) | (uint16_t)p4b;
}
